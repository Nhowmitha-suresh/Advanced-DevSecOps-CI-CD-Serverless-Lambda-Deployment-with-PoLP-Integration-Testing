name: CI - Build, Test, Deploy (staging)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]


permissions:
  contents: read
  id-token: write
  actions: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_test_and_deploy:
    name: CI/CD Pipeline - Staging / build_test_and_deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print repo files for debug
        run: |
          echo "Files at repo root:"
          ls -la

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Check for package.json
        run: |
          if [ -f package.json ]; then
            echo "package.json found"
          else
            echo "ERROR: package.json not found - adjust workflow or repo" && exit 2
          fi

      - name: Install dependencies
        run: |
          npm ci
        env:
          CI: true

      - name: Run unit tests (if present)
        run: |
          if grep -q "\"test\"" package.json; then
            echo "Running npm test"
            npm test
          else
            echo "No test script defined in package.json â€” skipping tests"
          fi

      - name: Build (if present)
        run: |
          if grep -q "\"build\"" package.json; then
            echo "Running npm run build"
            npm run build
          else
            echo "No build script defined - skipping build"
          fi

      - name: Install Serverless CLI
        run: |
          npm install -g serverless
          serverless --version

      - name: Debug environment variable presence
        run: |
          echo "SERVERLESS_ACCESS_KEY present? " && [ -n "$SERVERLESS_ACCESS_KEY" ] && echo "YES" || echo "NO"
        env:
          SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }}

      - name: Deploy to staging (Serverless)
        env:
          SERVERLESS_ACCESS_KEY: ${{ secrets.SERVERLESS_ACCESS_KEY }}
          # If using AWS add AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY as repo secrets and uncomment below:
          # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -e
          echo "Running: serverless deploy --stage staging"
          serverless deploy --stage staging
